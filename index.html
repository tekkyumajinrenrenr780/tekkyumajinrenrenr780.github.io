<!DOCTYPE html>
<html>
<head>
    <title>ユーザー別データ推移</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container {
            width: 80%;
            margin: 20px auto;
        }
        .user-selector {
            margin: 20px 0;
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-selector">
            <h3>表示するユーザーを選択:</h3>
            <div id="checkbox-container" class="checkbox-container">
            </div>
        </div>
        <canvas id="myChart"></canvas>
        <div id="error-message" style="color: red;"></div>
    </div>

    <script>
        let myChart = null;
        let allData = {};

        async function fetchData() {
            const SHEET_ID = '1Y35BApMCv1posrfHAf_KwOYkB47vEFvQMeIaNDcTOic';
            const SHEET_NAME = '購入履歴';
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('データの取得に失敗しました');
                }
                const text = await response.text();
                console.log('取得したデータ:', text); // デバッグ用
                return parseCSV(text);
            } catch (error) {
                console.error('エラー:', error);
                document.getElementById('error-message').textContent = 
                    'データの取得に失敗しました。スプレッドシートの設定を確認してください。';
                return [];
            }
        }

        function parseCSV(text) {
            // CSVパースのデバッグ出力
            console.log('パース前のテキスト:', text);
            
            const rows = text.split('\n')
                .map(row => row.split(',')
                .map(cell => cell.replace(/^"|"$/g, '')));
            
            console.log('パース後のデータ:', rows);
            return rows;
        }

        function processData(values) {
            if (!values || values.length === 0) {
                console.error('データが空です');
                return;
            }

            allData = {};
            const users = new Set();

            // ヘッダーをスキップしてデータを処理
            for (let i = 1; i < values.length; i++) {
                if (!values[i] || values[i].length < 3) continue;
                
                const [date, userId, value] = values[i];
                if (!date || !userId || !value) continue;

                console.log(`処理中: 日付=${date}, ユーザー=${userId}, 値=${value}`); // デバッグ用

                users.add(userId);
                
                if (!allData[userId]) {
                    allData[userId] = {};
                }
                if (!allData[userId][date]) {
                    allData[userId][date] = 0;
                }
                allData[userId][date] += parseFloat(value) || 0;
            }

            console.log('処理後のデータ:', allData); // デバッグ用
            createUserCheckboxes(Array.from(users));
            updateChart();
        }

        function createUserCheckboxes(users) {
            const container = document.getElementById('checkbox-container');
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<p>ユーザーデータが見つかりません</p>';
                return;
            }

            users.forEach(userId => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label>
                        <input type="checkbox" value="${userId}" onchange="updateChart()">
                        ${userId}
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function updateChart() {
            const selectedUsers = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (selectedUsers.length === 0) {
                if (myChart) {
                    myChart.destroy();
                    myChart = null;
                }
                return;
            }

            const datasets = selectedUsers.map((userId, index) => {
                const colors = [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(153, 102, 255, 1)',
                ];

                const userData = allData[userId];
                const dates = Object.keys(userData).sort();
                
                return {
                    label: `ユーザー ${userId}`,
                    data: dates.map(date => userData[date]),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length].replace('1)', '0.2)'),
                    tension: 0.3,
                    fill: true
                };
            });

            const dates = selectedUsers.length > 0 ? 
                Object.keys(allData[selectedUsers[0]]).sort() : [];

            if (myChart) {
                myChart.destroy();
            }

            const ctx = document.getElementById('myChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ユーザー別データ推移'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '合算値'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日付'
                            }
                        }
                    }
                }
            });
        }

        // 初期データ読み込みとエラーハンドリング
        async function initialize() {
            try {
                const data = await fetchData();
                if (data && data.length > 0) {
                    processData(data);
                } else {
                    document.getElementById('error-message').textContent = 
                        'データが見つかりませんでした。';
                }
            } catch (error) {
                console.error('初期化エラー:', error);
                document.getElementById('error-message').textContent = 
                    '初期化中にエラーが発生しました。';
            }
        }

        // 初期化実行
        initialize();
    </script>
</body>
</html> 